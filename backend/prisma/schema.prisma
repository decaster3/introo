generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String
  avatar             String?
  title              String?
  company            String?
  companyDomain      String?
  linkedinUrl        String?
  headline           String?
  city               String?
  country            String?
  googleAccessToken  String?
  googleRefreshToken String?
  calendarSyncedAt   DateTime?
  emailPreferences   Json                @default("{\"intros\":true,\"notifications\":true,\"digests\":true}")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  contacts           Contact[]
  introOffers        IntroOffer[]        @relation("Introducer")
  introRequests      IntroRequest[]      @relation("Requester")
  spaceMemberships   SpaceMember[]
  ownedSpaces        Space[]             @relation("SpaceOwner")
  relationships      Relationship[]
  signals            Signal[]
  calendarAccounts   CalendarAccount[]
  sentConnections    DirectConnection[]  @relation("ConnectionFrom")
  receivedConnections DirectConnection[] @relation("ConnectionTo")
  notifications      Notification[]
  tags               Tag[]
  pendingInvites     PendingInvite[]

  @@map("users")
}

model CalendarAccount {
  id                 String    @id @default(cuid())
  userId             String
  email              String
  name               String?
  googleAccessToken  String
  googleRefreshToken String?
  lastSyncedAt       DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts           Contact[]
  sourceContacts     Contact[] @relation("ContactSources")

  @@unique([userId, email])
  @@index([userId])
  @@map("calendar_accounts")
}

model Space {
  id          String         @id @default(cuid())
  name        String
  description String?
  emoji       String         @default("ðŸ«›")
  isPrivate   Boolean        @default(true)
  inviteCode  String         @unique @default(cuid())
  ownerId     String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  requests       IntroRequest[]
  members        SpaceMember[]
  pendingInvites PendingInvite[]
  owner          User           @relation("SpaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("pods")
}

model SpaceMember {
  id       String   @id @default(cuid())
  spaceId  String   @map("podId")
  userId   String
  role     String   @default("member")
  joinedAt DateTime @default(now())
  status   String   @default("approved")
  space    Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId], map: "pod_members_podId_userId_key")
  @@index([userId])
  @@index([status])
  @@map("pod_members")
}

model Company {
  id               String         @id @default(cuid())
  domain           String         @unique
  name             String
  industry         String?
  sizeBucket       String?
  geo              String?
  logo             String?
  employeeCount    Int?
  employeeRange    String?
  foundedYear      Int?
  annualRevenue    String?
  totalFunding     String?
  lastFundingRound String?
  lastFundingDate  DateTime?
  linkedinUrl      String?
  websiteUrl       String?
  city             String?
  state            String?
  country          String?
  description      String?
  technologies     Json?
  apolloId         String?
  enrichedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  contacts         Contact[]
  relationships    Relationship[]
  companyTags      CompanyTag[]

  @@map("companies")
}

model Tag {
  id        String       @id @default(cuid())
  userId    String
  name      String
  color     String       @default("#5b8def")
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  companies CompanyTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

model CompanyTag {
  id        String   @id @default(cuid())
  tagId     String
  companyDomain String
  companyId String?
  userId    String
  createdAt DateTime @default(now())
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([tagId, companyDomain])
  @@index([userId])
  @@index([companyDomain])
  @@index([companyId])
  @@map("company_tags")
}

model Contact {
  id                String           @id @default(cuid())
  email             String
  name              String?
  title             String?
  avatarUrl         String?
  userId            String
  companyId         String?
  meetingsCount     Int              @default(1)
  lastSeenAt        DateTime         @default(now())
  lastEventTitle    String?
  linkedinUrl       String?
  photoUrl          String?
  city              String?
  state             String?
  country           String?
  headline          String?
  apolloId          String?
  enrichedAt        DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  isApproved        Boolean          @default(false)
  source            String           @default("manual")
  sourceAccountId   String?
  company           Company?         @relation(fields: [companyId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceAccount     CalendarAccount? @relation(fields: [sourceAccountId], references: [id], onDelete: SetNull)
  sourceAccounts    CalendarAccount[] @relation("ContactSources")
  meetings          Meeting[]

  @@unique([userId, email])
  @@index([userId])
  @@index([companyId])
  @@index([lastSeenAt])
  @@index([sourceAccountId])
  @@map("contacts")
}

model Meeting {
  id          String   @id @default(cuid())
  contactId   String
  title       String
  date        DateTime
  duration    Int?     // in minutes
  createdAt   DateTime @default(now())
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([date])
  @@map("meetings")
}

model Relationship {
  id            String   @id @default(cuid())
  userId        String
  companyId     String
  meetingsCount Int      @default(1)
  lastSeenAt    DateTime @default(now())
  strengthScore Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("relationships")
}

model IntroRequest {
  id              String       @id @default(cuid())
  requesterId     String
  rawText         String
  normalizedQuery Json         @default("{}")
  bidAmount       Float        @default(0)
  currency        String       @default("USD")
  status          String       @default("open")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  spaceId         String?      @map("podId")
  offers          IntroOffer[]
  space           Space?       @relation(fields: [spaceId], references: [id])
  requester       User         @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([requesterId])
  @@index([spaceId], map: "intro_requests_podId_idx")
  @@index([status])
  @@index([createdAt])
  @@map("intro_requests")
}

model IntroOffer {
  id           String       @id @default(cuid())
  requestId    String
  introducerId String
  message      String
  status       String       @default("pending")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  introducer   User         @relation("Introducer", fields: [introducerId], references: [id], onDelete: Cascade)
  request      IntroRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([introducerId])
  @@index([status])
  @@map("intro_offers")
}

model Signal {
  id          String        @id @default(cuid())
  userId      String
  name        String
  description String?
  entityType  String
  triggerType String
  config      Json          @default("{}")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  matches     SignalMatch[]
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("signals")
}

model SignalMatch {
  id         String   @id @default(cuid())
  signalId   String
  entityType String
  entityId   String
  summary    String
  data       Json     @default("{}")
  isRead     Boolean  @default(false)
  matchedAt  DateTime @default(now())
  createdAt  DateTime @default(now())
  signal     Signal   @relation(fields: [signalId], references: [id], onDelete: Cascade)

  @@index([signalId])
  @@index([entityId])
  @@index([isRead])
  @@index([matchedAt])
  @@map("signal_matches")
}

model DirectConnection {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  status     String   @default("pending") // pending, accepted, rejected
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  fromUser   User     @relation("ConnectionFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("ConnectionTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@map("direct_connections")
}

model PendingInvite {
  id         String   @id @default(cuid())
  fromUserId String
  email      String
  spaceId    String?
  status     String   @default("pending") // pending, converted, cancelled
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  fromUser   User     @relation(fields: [fromUserId], references: [id], onDelete: Cascade)
  space      Space?   @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([fromUserId, email])
  @@index([email])
  @@index([status])
  @@index([spaceId])
  @@map("pending_invites")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "intro_request", "intro_offer", etc.
  title     String
  body      String?
  data      Json     @default("{}")  // { requestId, spaceId, companyName, etc. }
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
